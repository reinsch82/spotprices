<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Price Navigator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            text-align: left;
            padding: 8px;
        }
        th {
            background-color: #f4f4f4;
        }
        #pagination {
            margin-top: 20px;
            text-align: center;
        }
        button {
            padding: 8px 16px;
            margin: 0 5px;
            cursor: pointer;
        }
        #chart-container {
            margin-top: 20px;
            margin-bottom: 40px;
        }
    </style>
</head>
<body>

<h1>Energy Price Navigator</h1>
<p>Select a start and end date to fetch the energy price data within a range:</p>

<label for="start-date">Start Date:</label>
<input type="date" id="start-date">
<label for="end-date">End Date:</label>
<input type="date" id="end-date">
<button onclick="fetchData()">Fetch Data</button>

<div id="chart-container">
    <canvas id="price-chart"></canvas>
</div>

<table id="data-table">
    <thead>
        <tr>
            <th>Start Time</th>
            <th>End Time</th>
            <th>Market Price (ct/kWh)</th>
            <th>Unit</th>
        </tr>
    </thead>
    <tbody>
        <!-- Data will be dynamically inserted here -->
    </tbody>
</table>

<div id="pagination">
    <button onclick="prevPage()">Previous</button>
    <span id="page-info">Page: 1</span>
    <button onclick="nextPage()">Next</button>
</div>

<script>
    let data = [];
    let currentPage = 1;
    const pageSize = 10;
    let chart;

    // Set default values for date inputs
    window.onload = () => {
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

        document.getElementById('start-date').value = firstDayOfMonth.toISOString().split('T')[0];
        document.getElementById('end-date').value = today.toISOString().split('T')[0];
    };

    async function fetchData() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        if (!startDate || !endDate) {
            alert("Please select both a start and end date.");
            return;
        }

        // Convert the selected dates to Unix timestamps in milliseconds
        const startTimestamp = new Date(startDate).getTime();
        const endTimestamp = new Date(endDate).getTime();

        if (endTimestamp <= startTimestamp) {
            alert("The end date must be after the start date.");
            return;
        }

        const url = `https://api.awattar.at/v1/marketdata?start=${startTimestamp}&end=${endTimestamp}`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Failed to fetch data: ${response.statusText}`);
            }
            const result = await response.json();
            data = result.data;
            currentPage = 1;
            updateChart();
            updateTable();
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    function updateTable() {
        const tableBody = document.querySelector("#data-table tbody");
        tableBody.innerHTML = ""; // Clear the table

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, data.length);
        const pageData = data.slice(startIndex, endIndex);

        pageData.forEach(entry => {
            const startTime = new Date(entry.start_timestamp).toLocaleString();
            const endTime = new Date(entry.end_timestamp).toLocaleString();
            const marketPriceCtKWh = (entry.marketprice * 0.1).toFixed(2); // Convert EUR/MWh to ct/kWh
            const row = `
                <tr>
                    <td>${startTime}</td>
                    <td>${endTime}</td>
                    <td>${marketPriceCtKWh}</td>
                    <td>ct/kWh</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });

        // Update pagination info
        document.getElementById('page-info').textContent = `Page: ${currentPage}`;
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            updateTable();
        }
    }

    function nextPage() {
        if (currentPage * pageSize < data.length) {
            currentPage++;
            updateTable();
        }
    }

    function updateChart() {
        const labels = data.map(entry =>
            new Date(entry.start_timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        );
        const tooltips = data.map(entry => ({
            date: new Date(entry.start_timestamp).toLocaleDateString(),
            time: new Date(entry.start_timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            price: (entry.marketprice * 0.1).toFixed(2) // Convert EUR/MWh to ct/kWh
        }));

        const ctx = document.getElementById('price-chart').getContext('2d');

        // Destroy existing chart instance if it exists
        if (chart) {
            chart.destroy();
        }

        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Market Price (ct/kWh)',
                    data: tooltips.map(item => item.price),
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                const tooltip = tooltips[tooltipItem.dataIndex];
                                return `Date: ${tooltip.date}, Time: ${tooltip.time}, Price: ${tooltip.price} ct/kWh`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Market Price (ct/kWh)'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }
</script>

</body>
</html>